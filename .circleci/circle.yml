version: 2
jobs:
  build:
    docker:
      - image: docker
      - image: jimdo/reportbook
      - image: mysql:5.7.22
      - image: selenium/hub:2.53.0
      - image: selenium/node-chrome-debug:2.53.0
      - image: mongo
    environment:
      MYSQL_DATABASE: 'reportbook_test'
      MYSQL_USER: 'reportbook-test'
      MYSQL_PASSWORD: 'geheim'
      MYSQL_ROOT_PASSWORD: 'geheim'
      SELENIUM_IP: 'localhost'
    steps:
      - checkout
      - run: docker-compose up
      - run: docker-compose exec mongo /scripts/intall-composer.sh
      - run: docker-compose exec mongo /scripts/composer install
      - run: docker-compose exec mongo /scripts/setup-mongo-server.sh
      - run: docker-compose exec mysql /scripts/setup-mysql-server.sh
      - run: docker-compose run reportbook scripts/phpunit

  deploy-job:
    wonderland:
      - branch: master
      - run: make deploy